name: ⭐ Update awesome-stars
on:
  push:
  workflow_dispatch:
  schedule:
    - cron: 30 0 * * *

jobs:
  delete_old_runs:
    name: 🧹 Delete old workflow runs
    runs-on: ubuntu-latest

    steps:
      - name: 🧹 Delete old workflow runs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/actions/runs \
          --paginate -q '.workflow_runs[] | select(.status != "in_progress" and .status != "queued") | "\(.id)"' | \
          xargs -n1 -I % gh api repos/${{ github.repository }}/actions/runs/% -X DELETE

  awesome-stars:
    name: ⭐ Update awesome-stars
    runs-on: ubuntu-latest
    steps:
      - name: ⬇ Checkout
        uses: actions/checkout@v2

      - name: 🔧 Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.7'

      - name: 🔧 Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --user importlib-metadata setuptools wheel
          pip install --user -v git+https://github.com/mehdichaouch/starred#egg=starred

      - name: 🔧 WIP
        run: pip list
      - name: 🔧 WIP
        run: pip freeze --local 
      - name: 🔧 WIP
        run: |
          pip --version
          pip show starred
          # echo ${GITHUB_WORKSPACE}
          # ls -l ${GITHUB_WORKSPACE}/src/starred/starred
          # ls -l /usr/local/bin
          # PYTHON_BIN_PATH="$(python3 -m site --user-base)/bin"
          # PATH="$PATH:$PYTHON_BIN_PATH"
          # echo $PYTHON_BIN_PATH
          # ls -l $PATH
          # pip3 freeze
      - name: 🔧 WIP
        run: |
          echo $PATH
          # export PATH=$PATH:~/.local/bin
          #~/.local/bin/starred --help
          which starred

      - name: ⭐ Update awesome-stars README
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          #python -m 
          starred --username ${GITHUB_REPOSITORY_OWNER} --sort > README.md
          # python ${GITHUB_WORKSPACE}/src/starred/starred/starred.py --username ${GITHUB_REPOSITORY_OWNER} --sort > ${GITHUB_WORKSPACE}/README.md

      - name: 🤖 Commit generate README changes
        uses: stefanzweifel/git-auto-commit-action@v4
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          commit_message: 🤖 Update generated README
          branch: main
          commit_user_name: awesome-stars 🤖
          commit_user_email: actions@github.com
          commit_author: awesome-stars 🤖 <actions@github.com>
